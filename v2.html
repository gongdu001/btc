<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=400, user-scalable=no" />
  <title>BTC Í∞ÄÍ≤© Í∏âÎ≥ÄÎèô ÏïåÎ¶º</title>
  <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }
        
        .price-display {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .current-price {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .price-change {
            font-size: 18px;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
        }
        
        .price-up {
            background: #4CAF50;
        }
        
        .price-down {
            background: #f44336;
        }
        
        .settings {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        input[type="number"] {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 16px;
        }
        
        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .status {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .alert-log {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
        }
        
        .alert-item {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 14px;
        }
        
        .alert-item:last-child {
            border-bottom: none;
        }
        
        .error {
            background: rgba(244, 67, 54, 0.2);
            color: #ffcdd2;
        }
        
        .server-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .server-info code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
</head>
<body>
  <div class="container">
    <h1>ü™ô BTC/USDT Í∞ÄÍ≤© ÏïåÎ¶º</h1>
    <div class="current-price" id="currentPrice">-</div>
    <div class="price-change" id="priceChange">ÎåÄÍ∏∞Ï§ë...</div>

    <div class="input-group">
      <label>Í∏âÎ≥ÄÎèô Í∏∞Ï§Ä (%)</label>
      <input type="number" id="threshold" value="1" min="0.1" step="0.1" />
    </div>
    <div class="input-group">
      <label>Î≥ÄÌôîÏú® Ï∏°Ï†ï ÏãúÍ∞Ñ (Ï¥à)</label>
      <input type="number" id="timeframe" value="60" min="10" step="10" />
    </div>
    <div class="input-group">
      <label>Ï≤¥ÌÅ¨ Í∞ÑÍ≤© (Ï¥à)</label>
      <input type="number" id="interval" value="5" min="1" step="1" />
    </div>

    <button id="toggleBtn" onclick="toggleMonitoring()">Î™®ÎãàÌÑ∞ÎßÅ ÏãúÏûë</button>
    <button id="notificationBtn" onclick="requestNotificationPermission()">ÏïåÎ¶º Í∂åÌïú ÏöîÏ≤≠</button>
    <div class="status" id="status">Ï§ÄÎπÑ ÏôÑÎ£å</div>
    <div class="alert-log" id="alertLog"></div>
  </div>

  <script>
    let isMonitoring = false;
    let intervalId = null;
    let priceHistory = [];

    // Service Worker Îì±Î°ù
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').then(() => {
        console.log('‚úÖ Service Worker registered');
      }).catch(err => {
        console.error('‚ùå Service Worker Îì±Î°ù Ïã§Ìå®:', err);
      });
    }

    function requestNotificationPermission() {
      if (!('Notification' in window)) {
        updateStatus('Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî ÏïåÎ¶ºÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§');
        return;
      }
      if (Notification.permission === 'granted') {
        updateStatus('Ïù¥ÎØ∏ ÏïåÎ¶º Í∂åÌïúÏù¥ ÌóàÏö©ÎêòÏñ¥ ÏûàÏäµÎãàÎã§');
        document.getElementById('notificationBtn').style.display = 'none';
        return;
      }
      if (Notification.permission === 'denied') {
        updateStatus('üîí Î∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏóêÏÑú ÏïåÎ¶ºÏùÑ ÌóàÏö©Ìï¥Ï£ºÏÑ∏Ïöî');
        alert('‚ö†Ô∏è ÏïåÎ¶ºÏù¥ Ï∞®Îã®ÎêòÏñ¥ ÏûàÏäµÎãàÎã§. Î∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏóêÏÑú ÌóàÏö©Ìï¥Ï£ºÏÑ∏Ïöî.');
        return;
      }
      Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
          updateStatus('ÏïåÎ¶º Í∂åÌïúÏù¥ ÌóàÏö©ÎêòÏóàÏäµÎãàÎã§');
          document.getElementById('notificationBtn').style.display = 'none';
        } else {
          updateStatus('‚ùå ÏïåÎ¶º Í∂åÌïúÏù¥ Í±∞Î∂ÄÎêòÏóàÏäµÎãàÎã§');
        }
      });
    }

    function toggleMonitoring() {
      const btn = document.getElementById('toggleBtn');
      if (isMonitoring) {
        stopMonitoring();
        btn.textContent = 'Î™®ÎãàÌÑ∞ÎßÅ ÏãúÏûë';
        updateStatus('Î™®ÎãàÌÑ∞ÎßÅ Ï§ëÏßÄÎê®');
      } else {
        startMonitoring();
        btn.textContent = 'Î™®ÎãàÌÑ∞ÎßÅ Ï§ëÏßÄ';
        updateStatus('Î™®ÎãàÌÑ∞ÎßÅ ÏãúÏûëÎê®');
      }
    }

    function startMonitoring() {
      isMonitoring = true;
      priceHistory = [];
      checkPrice();
      const interval = parseInt(document.getElementById('interval').value);
      intervalId = setInterval(checkPrice, interval * 1000);
    }

    function stopMonitoring() {
      isMonitoring = false;
      if (intervalId) clearInterval(intervalId);
    }

    async function checkPrice() {
      try {
        const response = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');
        const data = await response.json();
        const price = parseFloat(data.price);
        document.getElementById('currentPrice').textContent = `$${price.toFixed(2)}`;
        priceHistory.push(price);

        const timeframe = parseInt(document.getElementById('timeframe').value);
        const interval = parseInt(document.getElementById('interval').value);
        const maxHistory = Math.ceil(timeframe / interval) + 1;
        if (priceHistory.length > maxHistory) priceHistory.shift();

        const change = calculateChange(price);
        if (change !== null) {
          const threshold = parseFloat(document.getElementById('threshold').value);
          document.getElementById('priceChange').textContent = `Î≥ÄÌôîÏú®: ${change.toFixed(2)}%`;

          if (Math.abs(change) >= threshold) {
            sendNotification(price, change);
          }
        } else {
          document.getElementById('priceChange').textContent = 'Îç∞Ïù¥ÌÑ∞ ÏàòÏßë Ï§ë...';
        }

        updateStatus(`ÎßàÏßÄÎßâ Ï≤¥ÌÅ¨: ${new Date().toLocaleTimeString()}`);
      } catch (err) {
        updateStatus('Í∞ÄÍ≤© Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®');
        console.error(err);
      }
    }

    function calculateChange(currentPrice) {
      const timeframe = parseInt(document.getElementById('timeframe').value);
      const interval = parseInt(document.getElementById('interval').value);
      const points = Math.floor(timeframe / interval);
      if (priceHistory.length < points) return null;
      const oldPrice = priceHistory[priceHistory.length - points];
      return ((currentPrice - oldPrice) / oldPrice) * 100;
    }

    function sendNotification(price, change) {
      const message = `BTCÍ∞Ä ${Math.abs(change).toFixed(2)}% ${change > 0 ? 'ÏÉÅÏäπ' : 'ÌïòÎùΩ'}ÌñàÏäµÎãàÎã§! ÌòÑÏû¨Í∞Ä: $${price.toFixed(2)}`;
      addLog(message);
      playSound();

      if (navigator.serviceWorker && navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({
          type: 'SHOW_NOTIFICATION',
          title: '‚ö†Ô∏è BTC Í∞ÄÍ≤© Í∏âÎ≥ÄÎèô!',
          body: message,
          icon: 'https://cdn-icons-png.flaticon.com/512/1490/1490849.png'
        });
      }
    }

    function addLog(msg) {
      const div = document.getElementById('alertLog');
      const time = new Date().toLocaleTimeString();
      div.innerHTML = `[${time}] ${msg}<br>` + div.innerHTML;
    }

    function playSound() {
      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE');
      audio.play().catch(console.error);
    }

    function updateStatus(msg) {
      document.getElementById('status').textContent = msg;
    }

    // ÏûêÎèô Ïã§Ìñâ
    checkPrice();
    if (Notification.permission === 'granted') {
      document.getElementById('notificationBtn').style.display = 'none';
    }
  </script>
</body>
</html>
